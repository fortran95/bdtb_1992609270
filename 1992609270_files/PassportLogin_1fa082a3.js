var PassportSign=new (function(){TbICom.call(this);var i=this;var k=new window.CommonUiDecorator();var a={dialog:null,action_type:"default",focus_tab:"normalLogin",jump_url:"",callback:null,action:{},trigger_pos:"",dialog_title:"登录",onAfterLogined:null,dialogConfig:{width:598,height:"auto",title:"登录",position:"center",holderClassName:"login_dialog"},loginFormConfig:{signClass:"comLoginForm",parentId:"",focus_tab:"normalLogin"},bdPassInstance:null,doAfterLogined:function(){$.stats.sendRequest("st_type=login_succeed&fr=tb0&st_pos="+a.trigger_pos);if(this.onAfterLogined){if(this.onAfterLogined()){return}}if(typeof(a.callback)=="function"){a.callback();a.callback=null}else{var l=a.action_type;if(typeof(a.action[l])=="function"){a.action[l]()}else{if(location.href.indexOf("index.html")>0){TbCom.process("User","getUserInfoByRequest",b)}a.reload()}}},reload:function(){$.dialog.close();setTimeout(function(){if(a.jump_url!=""){window.location.href=a.jump_url}else{var m=window.location.href;var l=m.replace(/[&]?auth=[^&]*/,"").replace(/[&]?errno=[^&]*/,"");if(m==l){window.location.reload(true)}else{window.location.href=l}}},200)},showDialog:function(l,o){var n=l||"normalLogin";var m=null;if(l in a){m=a.dialogConfig}else{return}if(l=="normalLogin"){m.title=a.dialog_title}this.dialog=$.dialog.open(a.buildWrapperHtml(l,"comLoginForm"),m);a[l].buildHtml();this.showTypeImage(o);this.dialog.bind("onclose",function(){a[l].destroyLoginObj()});if(l=="normalLogin"){i.dispatchEvent("showNormalLoginDialog",a)}else{if(l=="phoneLogin"){i.dispatchEvent("showPhoneLoginDialog",a)}}},showTypeImage:function(l){var o;var m=this.dialog.getElement();switch(l){case"userBar":o=1;break;case"editor1":case"lzl":o=2;break;case"editor":o=3;break;case"lzonly":o=4;break;case"ilike":o=5;break;default:o=1}var n='<img src="http://tb2.bdstatic.com/tb/static-common/img/passport/logindlg_pic'+o+'.png" width="220" height="276"/>';$(m).find(".j_passport_sign_asidearea").html(n)},showLoginForm:function(l){l=$.extend(a.loginFormConfig,l);$("#"+l.parentId).html(a.buildWrapperHtml(l.focus_tab,l.signClass,true));a[l.focus_tab].buildHtml(l)},init:function(w,l,v,u,n,t){var m=w||"normalLogin";var r=l||"default";this.action_type=r;this.focus_tab=m;a.trigger_pos=n||"";var p=a.trigger_pos;a.dialog_title=t||a.dialog_title;this.callback=v||null;if(u&&u.onAfterLogined){this.onAfterLogined=u.onAfterLogined}else{this.onAfterLogined=function(){return false}}var q=TbCom.process("User","getRegPageUrl",a.trigger_pos);switch(p){case"userBar":_loginImg=1;break;case"editor1":case"lzl":_loginImg=2;break;case"editor":_loginImg=3;break;case"lzonly":_loginImg=4;break;case"ilike":_loginImg=5;break;default:_loginImg=1}var s="http://tb2.bdstatic.com/tb/static-common/img/passport/logindlg_pic"+_loginImg+".png";var o="http://passport.baidu.com/js/pass_uni_loginWrapper.js?cdnversion=20121022";if(!a.bdPassInstance){$.JsLoadManager.use(o,function(){a.bdPassInstance=bdPass.pop.init({staticpage:"http://tieba.baidu.com/tb/v2Jump.html",apiopt:{tpl:"tb"},registerLink:q,onshow:function(){$.stats.sendRequest("st_type=login_start&fr=tb0&st_pos="+p);if(m=="normalLogin"){i.dispatchEvent("showNormalLoginDialog",a)}else{if(m=="phoneLogin"){i.dispatchEvent("showPhoneLoginDialog",a)}}},onLoginSuccess:function(y,x,z){a.doAfterLogined();i.dispatchEvent("afterLogined",a)},onSubmitStart:function(x){$.stats.sendRequest("st_type=login_click&fr=tb0&st_pos="+p);x.submit()},img:s});a.bdPassInstance.show()})}else{a.bdPassInstance.show(s)}},buildWrapperHtml:function(m,l,r){var q=this.action_type;var p=(q in a.header)?a.header[q]:"";var o=(q in a.footer)?a.footer[q]:"";var n='<div id="pass_sign_body" class="'+l+'"><div class="pass_login_top_info resend_email_success" style="display:none"></div><div class="pass_login_top_error" style="display:none"><div class="login_top_error_content"></div></div><div class="clearDiv"></div><div class="passport_sign_Lcontent"><div class="passpost_sign_header">'+p+"</div>"+a.nav.buildHtml(m)+'<div class="passpost_sign_wrapper passpost_sign_wrapper_shape"><div class="passpost_sign_before_cnt"></div><div class="passpost_sign_cnt"></div><div class="passport_sign_user_info"></div><div class = "passpost_sign_after_cnt"></div></div><div class="passpost_sign_footer">'+o+"</div></div>";if(!r){n+='<div class="j_passport_sign_asidearea passport_sign_Rcontent"></div>'}n+="</div>";return n},setConfig:function(l){},initForeLoginForm:function(l){if(l.length>0){a.loginForm.initMultiForeForm(l)}}};a.header={example:"<p>this is the header</p>"};a.footer={example:"<p>this is the header</p>"};a.nav={items:{normalLogin:["普通登录",""],phoneLogin:["手机登录",""]},buildHtml:function(p){var o=p||"normalLogin";var n=['<div class="passpost_sign_nav"><ul>'];var l="";for(var m in a.nav.items){if(m==p){l='<li class="focus" data-login-type="'+m+'" data-account="" data-pwd=""><a href="#" onclick="return false">'+a.nav.items[m][0]+"</a></li>"}else{l='<li data-login-type="'+m+'"  data-account="" data-pwd=""><a href="#" onclick="return false">'+a.nav.items[m][0]+"</a></li>"}n.push(l)}n.push('</ul><div class="passpost_sign_nav_line"></div></div>');return n.join("")},defaultTab:function(l){a.focus_tab=l},bindEventToNavItems:function(l){var m=$("#pass_sign_body"+l).find(".passpost_sign_nav li");if(m){m.each(function(){$(this).bind("click",function(){if(!$(this).hasClass("focus")){a.nav.clearFocusToNavItems(l);$(this).addClass("focus");a.loginForm.changLoginType($(this).attr("data-login-type"))}})})}},clearFocusToNavItems:function(l){$("#pass_sign_body"+l).find(".passpost_sign_nav li").each(function(){if($(this).hasClass("focus")){$(this).removeClass("focus");return}})}};a.normalLogin={class_name:"passport_normal_login",passApiConfig:{staticpage:"http://tieba.baidu.com/tb/v2Jump.html",tpl:"tb",onSubmitStart:function(l){$("#pass_sign_body"+l).find(".pass_login_top_error").hide();$.stats.sendRequest("st_type=login_click&fr=tb0&st_pos="+a.trigger_pos)},onSubmitedErr:function(p,m){var o=$("#pass_sign_body"+m);var l=o.find(".pass_login_top_error");if(p==110024){var n=$("#pass_loginLite_err"+m);n.html("");var q='此帐号还未激活，请到验证邮件中激活，或者&nbsp;<span class="re_send_email">重发验证邮件</span>';o.find(".login_top_error_content").html(q);o.find(".re_send_email").bind("click",function(){var s=$.trim($("#pass_loginLite_input_username"+m).val());var r="https://passport.baidu.com/v2/?regmailsend&callback=reSendEmailCallback&tpl=tb&user="+s+"&t="+(new Date()).getTime();$.JsLoadManager.use(r);$(this).closest(".pass_login_top_error").hide()});l.show();return}l.hide()},onSuccess:function(l,m){$.cookie("TIEBA_LOGINED_USER",m.username||"",{expires:365,path:"/"});a.doAfterLogined();i.dispatchEvent("afterLogined",a)},onInputOk:function(m,l){$("#pass_loginLite_err"+l).html("");k.clearEffect(m,"input_")},onInputErr:function(n,o,l){var m=$("#pass_sign_body"+l);m.find(".pass_login_top_error").hide();if(o==120011){$("#pass_loginLite_err"+l).html("请填写帐号")}}},buildHtml:function(l){if(!l){l={}}l=$.extend(a.normalLogin.passApiConfig,l);$.stats.sendRequest("st_type=login_start&fr=tb0&st_pos="+a.trigger_pos);a.loginForm.init(l)},destroyLoginObj:function(){a.loginForm.destroyLoginForm(a.normalLogin.fIndex)}};a.phoneLogin={passApiConfig:{staticpage:"http://tieba.baidu.com/tb/v2Jump.html",tpl:"tb",onSubmitStart:function(l){$("#pass_sign_body"+l).find(".pass_login_top_error").hide();$.stats.sendRequest("st_type=login_click&fr=tb0&st_pos="+a.trigger_pos)},onSubmitedErr:function(p,m){var o=$("#pass_sign_body"+m);var l=o.find(".pass_login_top_error");if(p==110024){var n=$("#pass_loginLite_err"+m);o.find(".login_top_error_content").html(n.html());n.html("");l.show();return}l.hide()},onSuccess:function(l){a.doAfterLogined();i.dispatchEvent("afterLogined",a)},onInputOk:function(m,l){$("#pass_loginLite_err"+l).html("");k.clearEffect(m,"input_")},onInputErr:function(m,n,l){$("#pass_sign_body"+l).find(".pass_login_top_error").hide()}},buildHtml:function(l){if(!l){l={}}l=$.extend(a.phoneLogin.passApiConfig,l);$.stats.sendRequest("st_type=login_start&fr=tb0&st_pos="+a.trigger_pos);a.loginForm.init(l)}};a.loginForm={formIndex:0,defaultConf:{staticpage:"http://tieba.baidu.com/tb/v2Jump.html",tpl:"tb",onSuccess:function(){a.doAfterLogined();i.dispatchEvent("afterLogined",a)}},buildHtml:function(m){var l='<form id="pass_loginLite_form'+m+'" target="pass_loginLite_iframe'+m+'" class="pass_loginLite_form" onSubmit="javascript:return false"><p class="pass_loginLite_p_err"><span id="pass_loginLite_err'+m+'" class="pass_loginLite_err"></span></p><p class="login-input-p-username clearfix"><label id="pass_loginLite_label_username'+m+'" for="pass_loginLite_input_username'+m+'" class="pass_loginLite_item_desc">帐号</label><input id="pass_loginLite_input_username'+m+'" class="pass_loginLite_input_username j_input_normal input_default" type="text"/><span class="tieba_loginLite_span_username">用户名/验证邮箱</span></p><p class="login-input-p clearfix"><label id="pass_loginLite_label_password'+m+'" for="pass_loginLite_input_password'+m+'" class="pass_loginLite_item_desc">密码</label><input id="pass_loginLite_input_password'+m+'" class="pass_loginLite_input_password j_input_normal input_default" type="password"/></p><p id="pass_loginLite_p_verifycode'+m+'" style="display:none" class="pass_loginLite_p_verifycode login-input-p clearfix"><label id="pass_loginLite_label_verifycode'+m+'" for="pass_loginLite_input_verifycode'+m+'" class="pass_loginLite_item_desc">验证码</label><input id="pass_loginLite_input_verifycode'+m+'" class="pass_loginLite_input_verifycode j_input_normal input_default" type="text"/><span id="pass_loginLite_verifycodeImg_wrapper'+m+'" class="pass_loginLite_verifycodeImg_wrapper"></span><a id="pass_loginLite_a_verifycode'+m+'" href="#" class="pass_loginLite_verifycodeunclear">看不清？</a></p><p class="login-input-state-p clearfix"><input id="pass_loginLite_input_isMem'+m+'" type="checkbox" checked="checked"><label id="pass_loginLite_label_isMem'+m+'" class="pass_loginLite_label_isMem" for="pass_loginLite_input_isMem'+m+'">记住我的登录状态</label></p><p class="login-input-btn-p pass_login_p_submit"><input id="pass_loginLite_input_submit'+m+'" class="j_pass_loginLite_input_submit pass_loginLite_input_submit" type="submit" value="登录"><a id="pass_loginLite_a_forgetpwd'+m+'" class="pass_loginLite_a_forgetpwd" href="https://passport.baidu.com/?getpass_index">忘记密码？</a><div class="pass_loginLite_regguide">还没有百度帐号？<a id="pass_loginLite_a_toreg'+m+"\" class=\"pass_loginLite_a_toreg\" onclick=\"TbCom.process('User', 'buildRegisterFrame','"+a.trigger_pos+'\');return false" href="#">立即注册</a></div></p><iframe name="pass_loginLite_iframe'+m+'" id="pass_loginLite_iframe'+m+'" src="javascript:\'\'" style="display:none;"></iframe></form>';return l},getDynamicFormIndexFromAPI:function(){if(typeof(window.bdPass_api_loginLite_loaded)!="undefined"){return bdPass.api.loginLite.getSuggestFormIndexArray(1)}return[0]},destroyLoginForm:function(){bdPass.api.loginLite.destroy([a.loginForm.formIndex])},init:function(m){window.bdPass_api_loginLite_userCallBack=function(){try{bdPass.api.loginLite.setUserConf(m)}catch(o){}};if(typeof(window.bdPass_api_loginLite_loaded)=="undefined"){var n="http://passport.bdimg.com/js/pass_api_newLoginLiteWrapper_v2.js?cdnversion=20121022";var l=false;$.JsLoadManager.use(n,function(){var o=setInterval(function(){if(typeof(window.bdPass_api_loginLite_loaded)!="undefined"){clearInterval(o);a.loginForm.loadFormHtml(m)}},20)});return}a.loginForm.loadFormHtml(m)},loadFormHtml:function(p){var l=a.loginForm.getDynamicFormIndexFromAPI();a.loginForm.formIndex=l[0];var o=$("#pass_sign_body");var n="pass_sign_body"+a.loginForm.formIndex;if(o.length>0){o.attr("id",n)}$("#"+n).find(".passpost_sign_cnt").html(a.loginForm.buildHtml(a.loginForm.formIndex));var m={formIndex:l[0],onFormReady:function(){a.loginForm.BindEventToForm();a.nav.bindEventToNavItems(a.loginForm.formIndex)}};m=$.extend(p,m);bdPass.api.loginLite.init([m]);var q=$.cookie("TIEBA_LOGINED_USER");if(q){$("span.tieba_loginLite_span_username").hide();$("#pass_loginLite_input_username"+a.loginForm.formIndex).val(decodeURIComponent(decodeURIComponent(q)));$("#pass_loginLite_input_password"+a.loginForm.formIndex).focus()}},changLoginType:function(t){var p=a.loginForm.formIndex;var m=$("#pass_sign_body"+p);m.find(".pass_loginLite_err").html("");var n=m.find(".passpost_sign_nav").find(".focus");var o=n.attr("data-account");var r=n.attr("data-pwd");m.find(".pass_loginLite_input_username").val("").val($.trim(o));m.find(".pass_loginLite_input_password").val("").val($.trim(r));var q=$(".tieba_loginLite_span_username");var l=$("#pass_loginLite_input_username"+p);var s=$("#pass_loginLite_label_username"+p);if(t=="phoneLogin"){bdPass.api.loginLite.switchToPhoneState(p);q.hide();s.html("手机号");return}if(l.val()==""){q.show()}s.html("帐号");bdPass.api.loginLite.switchToNormalState(p)},BindEventToForm:function(){var m=a.loginForm.formIndex;var o=$("#pass_sign_body"+m);var n=$("#pass_loginLite_input_username"+m);var l=$("#pass_loginLite_input_password"+m);var s=o.find(".tieba_loginLite_span_username");var r=o.find(".passpost_sign_nav").find(".focus");if(r.attr("data-login-type")=="phoneLogin"){s.hide()}if($.trim(n.val())!=""){s.hide()}var q=1500;var p=setInterval(function(){if($.trim(n.val())!=""){s.hide();clearInterval(p);return}if(q==0){clearInterval(p);return}q-=20},20);n.bind("focus",function(){s.hide()}).bind("blur",function(){var t=o.find(".passpost_sign_nav").find(".focus");if($.trim($(this).val())==""&&t.attr("data-login-type")!="phoneLogin"){s.show()}t.attr("data-account",$(this).val())});l.bind("blur",function(){var t=o.find(".passpost_sign_nav").find(".focus");t.attr("data-pwd",$(this).val())});s.bind("click",function(){n.focus()});k.addEffects(o.find("input.j_input_normal"),"input_",["hover","focus"]);k.addEffects(o.find(".j_pass_loginLite_input_submit"),"pass_loginLite_input_submit_",["hover","active"])},initMultiForeForm:function(n){window.bdPass_api_loginLite_userCallBack=function(){try{bdPass.api.loginLite.setUserConf(a.loginForm.defaultConf)}catch(o){}};if(typeof(window.bdPass_api_loginLite_loaded)=="undefined"){var m="http://passport.bdimg.com/js/pass_api_newLoginLiteWrapper_v2.js?cdnversion=20121022";var l=false;$.JsLoadManager.use(m,function(){var o=setInterval(function(){if(typeof(window.bdPass_api_loginLite_loaded)!="undefined"){clearInterval(o);bdPass.api.loginLite.init(n)}},20)});return}bdPass.api.loginLite.init(n)},resetEmail:function(m){var l=a.loginForm.formIndex;var o=$("#pass_sign_body"+l).find(".pass_login_top_info");if(m.errno==0){o.html("重发验证信成功");o.show();setTimeout(function(){o.hide()},3000);return}var n=$("#pass_loginLite_err"+l);n.html("重发验证信失败")}};var b=function(l){if(!l.no_un){location.href="/i/sys/jump"}};var j=function(m,p,q,n,l,o){a.init(m,p,q,n,l,o)};var d=function(l){a.showLoginForm(l)};var c=function(l){a.initForeLoginForm(l)};var g=function(l){a.nav.defaultTab(l)};var f=function(){a.reload()};var e=function(l){a.jump_url=l};var h=function(){};window.reSendEmailCallback=a.loginForm.resetEmail;this.doAfterLogined=a.doAfterLogined;this.initSys("PassportSign",[],{showDialog:j,showLoginForm:d,initForeLoginForm:c,defaultTab:g,reload:f,setJumpURL:e})})();